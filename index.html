<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Le Coeur du Donjon</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Courier New', monospace;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            color: #f0f0f0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .game-container {
            max-width: 900px;
            width: 100%;
            background: rgba(0, 0, 0, 0.7);
            border: 3px solid #8B4513;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(139, 69, 19, 0.5);
            overflow: hidden;
        }

        .game-header {
            background: linear-gradient(135deg, #8B4513 0%, #654321 100%);
            padding: 20px;
            text-align: center;
            border-bottom: 2px solid #DAA520;
        }

        .game-header h1 {
            color: #DAA520;
            font-size: 2em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.8);
            margin-bottom: 5px;
        }

        .game-header .subtitle {
            color: #f0f0f0;
            font-size: 0.9em;
            font-style: italic;
        }

        .game-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            padding: 15px;
            background: rgba(139, 69, 19, 0.2);
            border-bottom: 2px solid #8B4513;
        }

        .stat-box {
            background: rgba(0, 0, 0, 0.5);
            padding: 10px;
            border-radius: 5px;
            border: 1px solid #8B4513;
        }

        .stat-label {
            color: #DAA520;
            font-size: 0.8em;
            margin-bottom: 5px;
        }

        .stat-value {
            font-size: 1.2em;
            font-weight: bold;
        }

        .health-bar, .xp-bar {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.7);
            border-radius: 10px;
            overflow: hidden;
            margin-top: 5px;
            border: 1px solid #8B4513;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff0000 0%, #cc0000 100%);
            transition: width 0.3s ease;
        }

        .xp-fill {
            height: 100%;
            background: linear-gradient(90deg, #4169E1 0%, #1E90FF 100%);
            transition: width 0.3s ease;
        }

        .game-content {
            padding: 20px;
            min-height: 300px;
        }

        .game-screen {
            display: none;
        }

        .game-screen.active {
            display: block;
        }

        .story-text {
            line-height: 1.8;
            margin-bottom: 20px;
            color: #e0e0e0;
        }

        .game-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        button {
            background: linear-gradient(135deg, #8B4513 0%, #654321 100%);
            color: #DAA520;
            border: 2px solid #DAA520;
            padding: 12px 24px;
            font-family: 'Courier New', monospace;
            font-size: 1em;
            cursor: pointer;
            border-radius: 5px;
            transition: all 0.3s ease;
            flex: 1;
            min-width: 150px;
        }

        button:hover {
            background: linear-gradient(135deg, #654321 0%, #8B4513 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(218, 165, 32, 0.4);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .combat-log {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #8B4513;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }

        .combat-log p {
            margin: 5px 0;
            padding: 5px;
            border-left: 3px solid #DAA520;
            padding-left: 10px;
        }

        .combat-log p.damage {
            color: #ff6b6b;
        }

        .combat-log p.victory {
            color: #51cf66;
        }

        .combat-log p.info {
            color: #4dabf7;
        }

        .enemy-info {
            background: rgba(139, 0, 0, 0.3);
            padding: 15px;
            border-radius: 5px;
            border: 2px solid #8B0000;
            margin-bottom: 20px;
        }

        .enemy-info h3 {
            color: #ff6b6b;
            margin-bottom: 10px;
        }

        .shop-item {
            background: rgba(0, 0, 0, 0.5);
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #8B4513;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .shop-item-info {
            flex: 1;
        }

        .shop-item-price {
            color: #DAA520;
            font-weight: bold;
            margin-right: 15px;
        }

        input[type="text"] {
            background: rgba(0, 0, 0, 0.7);
            color: #f0f0f0;
            border: 2px solid #8B4513;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 1em;
            border-radius: 5px;
            width: 100%;
            max-width: 300px;
            margin: 10px 0;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #DAA520;
        }

        .game-footer {
            background: rgba(139, 69, 19, 0.2);
            padding: 15px;
            text-align: center;
            border-top: 2px solid #8B4513;
            font-size: 0.8em;
            color: #999;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .save-indicator {
            color: #51cf66;
            font-size: 0.9em;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .save-indicator.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <div class="game-header">
            <h1>‚öîÔ∏è Le Coeur du Donjon ‚öîÔ∏è</h1>
            <div class="subtitle">Un conte m√©di√©val et fantastique</div>
        </div>

        <div class="game-stats" id="gameStats" style="display: none;">
            <div class="stat-box">
                <div class="stat-label">Nom</div>
                <div class="stat-value" id="playerName">---</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Niveau</div>
                <div class="stat-value" id="playerLevel">1</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Or</div>
                <div class="stat-value" id="playerGold">0 üí∞</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Sant√©</div>
                <div class="stat-value" id="playerHealth">100/100</div>
                <div class="health-bar">
                    <div class="health-fill" id="healthFill" style="width: 100%;"></div>
                </div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Force</div>
                <div class="stat-value" id="playerStrength">10</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">D√©fense</div>
                <div class="stat-value" id="playerDefense">5</div>
            </div>
            <div class="stat-box">
                <div class="stat-label">√ânergie</div>
                <div class="stat-value" id="playerEnergy">100/100</div>
                <div class="health-bar">
                    <div class="health-fill" id="energyFill" style="width: 100%; background: linear-gradient(90deg, #FFD700 0%, #FFA500 100%);"></div>
                </div>
            </div>
            <div class="stat-box">
                <div class="stat-label">Exp√©rience</div>
                <div class="stat-value" id="playerXP">0/100</div>
                <div class="xp-bar">
                    <div class="xp-fill" id="xpFill" style="width: 0%;"></div>
                </div>
            </div>
        </div>

        <div class="game-content">
            <!-- Start Screen -->
            <div id="startScreen" class="game-screen active">
                <div class="story-text">
                    <p>Bienvenue, brave aventurier !</p>
                    <p>Dans le royaume oubli√© de Valoria, les t√©n√®bres s'√©tendent. Au coeur du donjon ancien se cache un artefact l√©gendaire - le Coeur du Donjon - capable de sauver le royaume.</p>
                    <p>Les l√©gendes racontent que seul un h√©ros courageux peut affronter les dangers qui gardent ce tr√©sor mystique...</p>
                    <p>√ätes-vous pr√™t √† devenir cette l√©gende ?</p>
                </div>
                <div>
                    <label for="nameInput" style="display: block; margin-bottom: 10px;">Entrez votre nom :</label>
                    <input type="text" id="nameInput" placeholder="Nom du h√©ros" maxlength="20">
                </div>
                <div class="game-actions">
                    <button onclick="startGame()">üó°Ô∏è Commencer l'Aventure</button>
                </div>
            </div>

            <!-- Main Game Screen -->
            <div id="mainScreen" class="game-screen">
                <div class="story-text">
                    <p>Vous vous tenez devant l'entr√©e du donjon. Les torches vacillent sur les murs de pierre ancienne. Que souhaitez-vous faire ?</p>
                </div>
                <div class="game-actions">
                    <button onclick="explore()">üó∫Ô∏è Explorer le Donjon</button>
                    <button onclick="showShop()">üè™ Visiter le Marchand</button>
                    <button onclick="rest()">üõå Dormir √† l'Auberge</button>
                    <button onclick="showStats()">üìä Voir Statistiques</button>
                </div>
            </div>

            <!-- Combat Screen -->
            <div id="combatScreen" class="game-screen">
                <div class="enemy-info" id="enemyInfo">
                    <h3 id="enemyName">Ennemi</h3>
                    <div class="stat-value" id="enemyHealth">HP: 50/50</div>
                    <div class="health-bar">
                        <div class="health-fill" id="enemyHealthFill" style="width: 100%;"></div>
                    </div>
                </div>
                <div class="combat-log" id="combatLog"></div>
                <div class="game-actions">
                    <button onclick="attack()">‚öîÔ∏è Attaquer</button>
                    <button onclick="defend()">üõ°Ô∏è D√©fendre</button>
                    <button onclick="flee()">üèÉ Fuir</button>
                </div>
            </div>

            <!-- Shop Screen -->
            <div id="shopScreen" class="game-screen">
                <div class="story-text">
                    <p>Un vieux marchand vous accueille avec un sourire √©dent√©. "Bienvenue dans ma modeste √©choppe ! Jetez un oeil √† mes marchandises..."</p>
                </div>
                <div id="shopItems"></div>
                <div class="game-actions">
                    <button onclick="showMain()">üö™ Retour</button>
                </div>
            </div>

            <!-- Stats Screen -->
            <div id="statsScreen" class="game-screen">
                <div class="story-text">
                    <h3>üìä Statistiques du H√©ros</h3>
                    <div id="detailedStats"></div>
                </div>
                <div class="game-actions">
                    <button onclick="showMain()">üö™ Retour</button>
                    <button onclick="showSaveOptions()">üíæ Sauvegardes</button>
                    <button onclick="resetGame()" style="background: linear-gradient(135deg, #8B0000 0%, #660000 100%);">üîÑ Nouvelle Partie</button>
                </div>
            </div>

            <!-- Save Options Screen -->
            <div id="saveOptionsScreen" class="game-screen">
                <div class="story-text">
                    <h3>üíæ Gestion des Sauvegardes</h3>
                    <p>Votre partie est automatiquement sauvegard√©e dans votre navigateur. Utilisez les options ci-dessous pour g√©rer vos sauvegardes :</p>
                    
                    <div class="shop-item" style="display: block; margin-top: 20px;">
                        <h4 style="color: #DAA520;">üì§ Exporter la Sauvegarde</h4>
                        <p>Obtenez un code de sauvegarde que vous pouvez copier et utiliser sur n'importe quel appareil.</p>
                        <button onclick="exportSave()" style="margin-top: 10px;">G√©n√©rer le Code</button>
                        <div id="exportResult" style="margin-top: 10px;"></div>
                    </div>
                    
                    <div class="shop-item" style="display: block; margin-top: 20px;">
                        <h4 style="color: #DAA520;">üì• Importer une Sauvegarde</h4>
                        <p>Entrez un code de sauvegarde pour restaurer votre progression.</p>
                        <input type="text" id="importCode" placeholder="Collez votre code ici" style="width: 100%; max-width: 100%;">
                        <button onclick="importSave()" style="margin-top: 10px;">Restaurer</button>
                        <div id="importResult" style="margin-top: 10px;"></div>
                    </div>
                    
                    <div class="shop-item" style="display: block; margin-top: 20px;">
                        <h4 style="color: #DAA520;">‚òÅÔ∏è Sauvegarde Automatique</h4>
                        <p>Statut: <span id="autoSaveStatus" style="color: #51cf66;">‚úì Active</span></p>
                        <p style="font-size: 0.9em; color: #999;">Les sauvegardes sont automatiquement enregistr√©es dans votre navigateur apr√®s chaque action.</p>
                    </div>
                </div>
                <div class="game-actions">
                    <button onclick="showStats()">üö™ Retour</button>
                </div>
            </div>

            <!-- Victory Screen -->
            <div id="victoryScreen" class="game-screen">
                <div class="story-text">
                    <h2 style="color: #DAA520; text-align: center; margin-bottom: 20px;">üèÜ Victoire ! üèÜ</h2>
                    <p>Apr√®s d'innombrables batailles, vous avez atteint le coeur du donjon !</p>
                    <p>Le Coeur du Donjon brille d'une lumi√®re mystique devant vous. En le touchant, vous sentez son pouvoir ancien couler dans vos veines.</p>
                    <p>Le royaume de Valoria est sauv√© gr√¢ce √† votre courage et votre pers√©v√©rance !</p>
                    <p style="text-align: center; margin-top: 30px; font-size: 1.2em; color: #DAA520;">F√©licitations, h√©ros l√©gendaire !</p>
                </div>
                <div class="game-actions">
                    <button onclick="resetGame()">üîÑ Nouvelle Aventure</button>
                </div>
            </div>
        </div>

        <div class="game-footer">
            <span>Le Coeur du Donjon - Un jeu inspir√© par Legend of the Red Dragon</span>
            <span class="save-indicator" id="saveIndicator">üíæ Sauvegard√©</span>
        </div>
    </div>

    <script>
        // Game State
        let gameState = {
            player: {
                name: '',
                level: 1,
                health: 100,
                maxHealth: 100,
                strength: 10,
                defense: 5,
                gold: 50,
                xp: 0,
                xpToLevel: 100,
                kills: 0,
                gamesPlayed: 0,
                energy: 100,
                maxEnergy: 100,
                lastSleepTime: null
            },
            currentEnemy: null,
            inCombat: false,
            defending: false
        };

        // Enemy templates
        const enemies = [
            { name: 'Rat G√©ant', health: 30, strength: 8, defense: 2, gold: 15, xp: 25 },
            { name: 'Gobelin', health: 50, strength: 12, defense: 4, gold: 25, xp: 40 },
            { name: 'Squelette', health: 60, strength: 15, defense: 6, gold: 35, xp: 50 },
            { name: 'Orc', health: 80, strength: 18, defense: 8, gold: 50, xp: 70 },
            { name: 'Loup-Garou', health: 100, strength: 22, defense: 10, gold: 75, xp: 90 },
            { name: 'Dragon Mineur', health: 150, strength: 28, defense: 15, gold: 150, xp: 150 }
        ];

        // Shop items
        const shopItems = [
            { name: 'Potion de Soin', description: 'Restaure 50 HP', cost: 30, effect: () => healPlayer(50) },
            { name: '√âp√©e en Acier', description: '+5 Force', cost: 100, effect: () => { gameState.player.strength += 5; } },
            { name: 'Armure de Cuir', description: '+3 D√©fense', cost: 80, effect: () => { gameState.player.defense += 3; } },
            { name: 'Grande Potion', description: 'Restaure 100 HP', cost: 60, effect: () => healPlayer(100) },
            { name: '√âp√©e Enchant√©e', description: '+10 Force', cost: 250, effect: () => { gameState.player.strength += 10; } },
            { name: 'Bouclier de Fer', description: '+5 D√©fense', cost: 200, effect: () => { gameState.player.defense += 5; } }
        ];

        // Check energy regeneration (6:00 AM Toronto time)
        function checkEnergyRegeneration() {
            const p = gameState.player;
            
            // If player hasn't slept yet, return
            if (!p.lastSleepTime) {
                return;
            }
            
            // Get current time in Toronto timezone (EST/EDT - UTC-5 or UTC-4)
            const now = new Date();
            const torontoTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Toronto' }));
            const lastSleep = new Date(p.lastSleepTime);
            
            // Calculate the next 6 AM after last sleep
            const nextRegeneration = new Date(lastSleep);
            nextRegeneration.setHours(6, 0, 0, 0);
            
            // If last sleep was after 6 AM, add one day
            if (lastSleep.getHours() >= 6) {
                nextRegeneration.setDate(nextRegeneration.getDate() + 1);
            }
            
            // Check if current time is past the regeneration time
            if (torontoTime >= nextRegeneration) {
                // Regenerate energy to full
                p.energy = p.maxEnergy;
                p.lastSleepTime = torontoTime.toISOString();
                saveGame();
                updateUI();
            }
        }
        
        // Consume energy for an action
        function consumeEnergy(amount) {
            const p = gameState.player;
            p.energy = Math.max(0, p.energy - amount);
            saveGame();
            updateUI();
            return p.energy >= 0;
        }
        
        // Check if player has enough energy
        function hasEnoughEnergy(amount) {
            return gameState.player.energy >= amount;
        }

        // Initialize game
        function init() {
            loadGame();
            checkEnergyRegeneration();
            updateUI();
        }

        // Start new game
        function startGame() {
            const name = document.getElementById('nameInput').value.trim();
            if (!name) {
                alert('Veuillez entrer un nom pour votre h√©ros !');
                return;
            }
            
            gameState.player.name = name;
            gameState.player.gamesPlayed++;
            saveGame();
            showScreen('mainScreen');
            updateUI();
        }

        // Show screen
        function showScreen(screenId) {
            document.querySelectorAll('.game-screen').forEach(screen => {
                screen.classList.remove('active');
            });
            document.getElementById(screenId).classList.add('active');
            
            if (screenId !== 'startScreen') {
                document.getElementById('gameStats').style.display = 'grid';
            } else {
                document.getElementById('gameStats').style.display = 'none';
            }
        }

        // Update UI
        function updateUI() {
            const p = gameState.player;
            document.getElementById('playerName').textContent = p.name || '---';
            document.getElementById('playerLevel').textContent = p.level;
            document.getElementById('playerGold').textContent = p.gold + ' üí∞';
            document.getElementById('playerHealth').textContent = `${p.health}/${p.maxHealth}`;
            document.getElementById('playerStrength').textContent = p.strength;
            document.getElementById('playerDefense').textContent = p.defense;
            document.getElementById('playerXP').textContent = `${p.xp}/${p.xpToLevel}`;
            document.getElementById('playerEnergy').textContent = `${p.energy}/${p.maxEnergy}`;
            
            // Update health bar
            const healthPercent = (p.health / p.maxHealth) * 100;
            document.getElementById('healthFill').style.width = healthPercent + '%';
            
            // Update XP bar
            const xpPercent = (p.xp / p.xpToLevel) * 100;
            document.getElementById('xpFill').style.width = xpPercent + '%';
            
            // Update energy bar
            const energyPercent = (p.energy / p.maxEnergy) * 100;
            document.getElementById('energyFill').style.width = energyPercent + '%';
        }

        // Explore dungeon
        function explore() {
            // Check if player has enough energy to explore
            if (!hasEnoughEnergy(10)) {
                alert('Vous √™tes trop fatigu√© pour explorer le donjon ! Allez dormir √† l\'auberge pour r√©cup√©rer votre √©nergie.');
                return;
            }
            
            // Consume energy for exploring
            consumeEnergy(10);
            
            // Random encounter - select enemy based on player level but ensure we don't exceed array bounds
            const maxEnemyIndex = Math.min(enemies.length - 1, gameState.player.level);
            const enemyTemplate = enemies[Math.floor(Math.random() * (maxEnemyIndex + 1))];
            
            gameState.currentEnemy = {
                ...enemyTemplate,
                maxHealth: enemyTemplate.health
            };
            
            gameState.inCombat = true;
            gameState.defending = false;
            
            showScreen('combatScreen');
            document.getElementById('combatLog').innerHTML = '';
            addCombatLog(`Vous rencontrez un ${gameState.currentEnemy.name} !`, 'info');
            updateEnemyUI();
        }

        // Update enemy UI
        function updateEnemyUI() {
            const e = gameState.currentEnemy;
            document.getElementById('enemyName').textContent = e.name;
            document.getElementById('enemyHealth').textContent = `HP: ${e.health}/${e.maxHealth}`;
            
            const healthPercent = (e.health / e.maxHealth) * 100;
            document.getElementById('enemyHealthFill').style.width = healthPercent + '%';
        }

        // Add combat log message
        function addCombatLog(message, type = '') {
            const log = document.getElementById('combatLog');
            const p = document.createElement('p');
            p.textContent = message;
            if (type) p.classList.add(type);
            log.appendChild(p);
            log.scrollTop = log.scrollHeight;
        }

        // Attack
        function attack() {
            if (!gameState.inCombat) return;
            
            const p = gameState.player;
            const e = gameState.currentEnemy;
            
            // Player attacks
            const playerDamage = Math.max(1, p.strength - e.defense + Math.floor(Math.random() * 5));
            e.health -= playerDamage;
            addCombatLog(`Vous infligez ${playerDamage} d√©g√¢ts au ${e.name} !`, 'damage');
            
            if (e.health <= 0) {
                // Victory
                p.gold += e.gold;
                p.xp += e.xp;
                p.kills++;
                addCombatLog(`Victoire ! Vous gagnez ${e.gold} or et ${e.xp} XP !`, 'victory');
                
                checkLevelUp();
                
                // Check for victory condition (10 kills)
                if (p.kills >= 10) {
                    setTimeout(() => showScreen('victoryScreen'), 2000);
                } else {
                    setTimeout(() => {
                        gameState.inCombat = false;
                        showScreen('mainScreen');
                    }, 2000);
                }
                
                saveGame();
                updateUI();
                return;
            }
            
            updateEnemyUI();
            
            // Enemy attacks
            setTimeout(() => {
                enemyAttack();
            }, 1000);
        }

        // Enemy attack
        function enemyAttack() {
            const p = gameState.player;
            const e = gameState.currentEnemy;
            
            let defense = p.defense;
            if (gameState.defending) {
                defense *= 2;
                gameState.defending = false;
            }
            
            const enemyDamage = Math.max(1, e.strength - defense + Math.floor(Math.random() * 5));
            p.health -= enemyDamage;
            addCombatLog(`Le ${e.name} vous inflige ${enemyDamage} d√©g√¢ts !`, 'damage');
            
            if (p.health <= 0) {
                // Defeat
                p.health = 0;
                addCombatLog('Vous avez √©t√© vaincu...', 'damage');
                setTimeout(() => {
                    p.health = Math.floor(p.maxHealth * 0.5);
                    p.gold = Math.floor(p.gold * 0.5);
                    gameState.inCombat = false;
                    saveGame();
                    updateUI();
                    alert('Vous avez √©t√© vaincu ! Vous perdez la moiti√© de votre or et vous r√©veillez √† l\'entr√©e du donjon.');
                    showScreen('mainScreen');
                }, 1500);
            }
            
            updateUI();
        }

        // Defend
        function defend() {
            if (!gameState.inCombat) return;
            
            gameState.defending = true;
            addCombatLog('Vous prenez une position d√©fensive !', 'info');
            
            setTimeout(() => {
                enemyAttack();
            }, 1000);
        }

        // Flee
        function flee() {
            if (!gameState.inCombat) return;
            
            const fleeChance = Math.random();
            if (fleeChance > 0.5) {
                addCombatLog('Vous fuyez le combat !', 'info');
                setTimeout(() => {
                    gameState.inCombat = false;
                    showScreen('mainScreen');
                }, 1000);
            } else {
                addCombatLog('Vous ne parvenez pas √† fuir !', 'damage');
                setTimeout(() => {
                    enemyAttack();
                }, 1000);
            }
        }

        // Check level up
        function checkLevelUp() {
            const p = gameState.player;
            if (p.xp >= p.xpToLevel) {
                p.level++;
                p.xp -= p.xpToLevel;
                p.xpToLevel = Math.floor(p.xpToLevel * 1.5);
                
                // Stat increases
                p.maxHealth += 20;
                p.health = p.maxHealth;
                p.strength += 5;
                p.defense += 3;
                
                addCombatLog(`üéâ Niveau sup√©rieur ! Vous √™tes maintenant niveau ${p.level} !`, 'victory');
                saveGame();
                updateUI();
            }
        }

        // Rest (now includes sleeping and energy restoration)
        function rest() {
            const p = gameState.player;
            const cost = 20;
            
            if (p.gold >= cost) {
                p.gold -= cost;
                p.health = p.maxHealth;
                p.energy = p.maxEnergy;
                
                // Set last sleep time to current Toronto time
                const now = new Date();
                const torontoTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Toronto' }));
                p.lastSleepTime = torontoTime.toISOString();
                
                saveGame();
                updateUI();
                alert('Vous dormez √† l\'auberge jusqu\'au lendemain √† 6h00 du matin. Votre sant√© et votre √©nergie sont compl√®tement restaur√©es ! (-20 or)');
            } else {
                alert('Vous n\'avez pas assez d\'or pour dormir √† l\'auberge ! (Co√ªt: 20 or)');
            }
        }

        // Heal player
        function healPlayer(amount) {
            const p = gameState.player;
            p.health = Math.min(p.maxHealth, p.health + amount);
            saveGame();
            updateUI();
        }

        // Show shop
        function showShop() {
            showScreen('shopScreen');
            const shopDiv = document.getElementById('shopItems');
            shopDiv.innerHTML = '';
            
            shopItems.forEach((item, index) => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'shop-item';
                itemDiv.innerHTML = `
                    <div class="shop-item-info">
                        <strong>${item.name}</strong><br>
                        <small>${item.description}</small>
                    </div>
                    <div class="shop-item-price">${item.cost} üí∞</div>
                    <button onclick="buyItem(${index})">Acheter</button>
                `;
                shopDiv.appendChild(itemDiv);
            });
        }

        // Buy item
        function buyItem(index) {
            const item = shopItems[index];
            const p = gameState.player;
            
            if (p.gold >= item.cost) {
                p.gold -= item.cost;
                item.effect();
                saveGame();
                updateUI();
                alert(`Vous avez achet√© ${item.name} !`);
                showShop(); // Refresh shop
            } else {
                alert(`Vous n'avez pas assez d'or ! (Co√ªt: ${item.cost} or)`);
            }
        }

        // Show stats
        function showStats() {
            showScreen('statsScreen');
            const p = gameState.player;
            const statsDiv = document.getElementById('detailedStats');
            statsDiv.innerHTML = `
                <div class="shop-item" style="display: block;">
                    <p><strong>Nom:</strong> ${p.name}</p>
                    <p><strong>Niveau:</strong> ${p.level}</p>
                    <p><strong>Sant√©:</strong> ${p.health}/${p.maxHealth}</p>
                    <p><strong>√ânergie:</strong> ${p.energy}/${p.maxEnergy}</p>
                    <p><strong>Force:</strong> ${p.strength}</p>
                    <p><strong>D√©fense:</strong> ${p.defense}</p>
                    <p><strong>Or:</strong> ${p.gold}</p>
                    <p><strong>Exp√©rience:</strong> ${p.xp}/${p.xpToLevel}</p>
                    <p><strong>Ennemis vaincus:</strong> ${p.kills}</p>
                    <p><strong>Parties jou√©es:</strong> ${p.gamesPlayed}</p>
                </div>
            `;
        }

        // Show save options
        function showSaveOptions() {
            showScreen('saveOptionsScreen');
            document.getElementById('exportResult').innerHTML = '';
            document.getElementById('importResult').innerHTML = '';
            document.getElementById('importCode').value = '';
        }

        // Export save
        function exportSave() {
            try {
                const saveData = JSON.stringify(gameState);
                const encoded = btoa(encodeURIComponent(saveData));
                
                const resultDiv = document.getElementById('exportResult');
                
                // Create elements safely to avoid XSS
                const container = document.createElement('div');
                container.style.cssText = 'background: rgba(0, 0, 0, 0.5); padding: 10px; border-radius: 5px; margin-top: 10px;';
                
                const successMsg = document.createElement('p');
                successMsg.style.cssText = 'color: #51cf66; margin-bottom: 10px;';
                successMsg.textContent = '‚úì Code g√©n√©r√© avec succ√®s !';
                
                const textarea = document.createElement('textarea');
                textarea.readOnly = true;
                textarea.style.cssText = 'width: 100%; max-width: 100%; height: 100px; background: rgba(0, 0, 0, 0.7); color: #f0f0f0; border: 1px solid #8B4513; padding: 10px; font-family: "Courier New", monospace; font-size: 0.8em; border-radius: 5px;';
                textarea.value = encoded;
                
                const copyBtn = document.createElement('button');
                copyBtn.textContent = 'üìã Copier le Code';
                copyBtn.style.cssText = 'margin-top: 10px;';
                copyBtn.addEventListener('click', () => copySaveCode(encoded));
                
                container.appendChild(successMsg);
                container.appendChild(textarea);
                container.appendChild(copyBtn);
                
                resultDiv.innerHTML = '';
                resultDiv.appendChild(container);
            } catch (e) {
                const errorMsg = document.createElement('p');
                errorMsg.style.color = '#ff6b6b';
                errorMsg.textContent = '‚ùå Erreur lors de l\'export: ' + e.message;
                document.getElementById('exportResult').innerHTML = '';
                document.getElementById('exportResult').appendChild(errorMsg);
            }
        }

        // Copy save code to clipboard
        function copySaveCode(code) {
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(code).then(() => {
                    alert('Code copi√© dans le presse-papiers !');
                }).catch(() => {
                    fallbackCopy(code);
                });
            } else {
                fallbackCopy(code);
            }
        }

        // Fallback copy method for browsers without Clipboard API
        function fallbackCopy(text) {
            const textarea = document.createElement('textarea');
            textarea.value = text;
            textarea.style.position = 'fixed';
            textarea.style.opacity = '0';
            document.body.appendChild(textarea);
            textarea.select();
            try {
                const success = document.execCommand('copy');
                if (success) {
                    alert('Code copi√© dans le presse-papiers !');
                } else {
                    alert('Impossible de copier automatiquement. Veuillez copier le code manuellement.');
                }
            } catch (e) {
                alert('Impossible de copier automatiquement. Veuillez copier le code manuellement.');
            }
            document.body.removeChild(textarea);
        }

        // Import save
        function importSave() {
            const code = document.getElementById('importCode').value.trim();
            const resultDiv = document.getElementById('importResult');
            
            if (!code) {
                const errorMsg = document.createElement('p');
                errorMsg.style.color = '#ff6b6b';
                errorMsg.textContent = '‚ùå Veuillez entrer un code de sauvegarde.';
                resultDiv.innerHTML = '';
                resultDiv.appendChild(errorMsg);
                return;
            }
            
            try {
                const decoded = decodeURIComponent(atob(code));
                const loadedState = JSON.parse(decoded);
                
                // Comprehensive validation of the loaded state
                if (!loadedState || typeof loadedState !== 'object') {
                    throw new Error('Invalid state structure');
                }
                
                // Validate player object and required properties
                const requiredPlayerProps = ['name', 'level', 'health', 'maxHealth', 'strength', 'defense', 'gold', 'xp', 'xpToLevel', 'kills', 'gamesPlayed'];
                if (!loadedState.player || typeof loadedState.player !== 'object') {
                    throw new Error('Missing player data');
                }
                
                for (const prop of requiredPlayerProps) {
                    if (!(prop in loadedState.player)) {
                        throw new Error(`Missing player property: ${prop}`);
                    }
                }
                
                // Add energy properties if they don't exist (for backwards compatibility)
                if (!('energy' in loadedState.player)) {
                    loadedState.player.energy = 100;
                }
                if (!('maxEnergy' in loadedState.player)) {
                    loadedState.player.maxEnergy = 100;
                }
                if (!('lastSleepTime' in loadedState.player)) {
                    loadedState.player.lastSleepTime = null;
                }
                
                // Validate property types for all player properties
                if (typeof loadedState.player.name !== 'string' || 
                    typeof loadedState.player.level !== 'number' ||
                    typeof loadedState.player.health !== 'number' ||
                    typeof loadedState.player.maxHealth !== 'number' ||
                    typeof loadedState.player.strength !== 'number' ||
                    typeof loadedState.player.defense !== 'number' ||
                    typeof loadedState.player.gold !== 'number' ||
                    typeof loadedState.player.xp !== 'number' ||
                    typeof loadedState.player.xpToLevel !== 'number' ||
                    typeof loadedState.player.kills !== 'number' ||
                    typeof loadedState.player.gamesPlayed !== 'number' ||
                    typeof loadedState.player.energy !== 'number' ||
                    typeof loadedState.player.maxEnergy !== 'number') {
                    throw new Error('Invalid player data types');
                }
                
                // Validate required state properties and their types
                if (typeof loadedState.inCombat !== 'boolean' || 
                    typeof loadedState.defending !== 'boolean') {
                    throw new Error('Invalid state property types');
                }
                
                // Validate currentEnemy if present
                if (loadedState.currentEnemy !== null) {
                    if (typeof loadedState.currentEnemy !== 'object' ||
                        typeof loadedState.currentEnemy.name !== 'string' ||
                        typeof loadedState.currentEnemy.health !== 'number' ||
                        typeof loadedState.currentEnemy.strength !== 'number' ||
                        typeof loadedState.currentEnemy.defense !== 'number' ||
                        typeof loadedState.currentEnemy.gold !== 'number' ||
                        typeof loadedState.currentEnemy.xp !== 'number') {
                        // If enemy data is invalid, clear it
                        loadedState.currentEnemy = null;
                        loadedState.inCombat = false;
                    }
                }
                
                // Restore the game state
                gameState = loadedState;
                saveGame();
                updateUI();
                
                const successMsg = document.createElement('p');
                successMsg.style.color = '#51cf66';
                successMsg.textContent = `‚úì Sauvegarde restaur√©e avec succ√®s ! Bienvenue, ${gameState.player.name} !`;
                resultDiv.innerHTML = '';
                resultDiv.appendChild(successMsg);
                
                setTimeout(() => {
                    showScreen('mainScreen');
                }, 2000);
            } catch (e) {
                const errorMsg = document.createElement('p');
                errorMsg.style.color = '#ff6b6b';
                errorMsg.textContent = '‚ùå Code invalide ou corrompu. Veuillez v√©rifier et r√©essayer.';
                resultDiv.innerHTML = '';
                resultDiv.appendChild(errorMsg);
            }
        }

        // Show main screen
        function showMain() {
            showScreen('mainScreen');
        }

        // Reset game
        function resetGame() {
            if (confirm('√ätes-vous s√ªr de vouloir recommencer une nouvelle partie ?')) {
                const gamesPlayed = gameState.player.gamesPlayed;
                gameState = {
                    player: {
                        name: '',
                        level: 1,
                        health: 100,
                        maxHealth: 100,
                        strength: 10,
                        defense: 5,
                        gold: 50,
                        xp: 0,
                        xpToLevel: 100,
                        kills: 0,
                        gamesPlayed: gamesPlayed,
                        energy: 100,
                        maxEnergy: 100,
                        lastSleepTime: null
                    },
                    currentEnemy: null,
                    inCombat: false,
                    defending: false
                };
                saveGame();
                document.getElementById('nameInput').value = '';
                showScreen('startScreen');
                updateUI();
            }
        }

        // Save game
        function saveGame() {
            localStorage.setItem('lecoeurdudonjon_save', JSON.stringify(gameState));
            showSaveIndicator();
        }

        // Show save indicator
        function showSaveIndicator() {
            const indicator = document.getElementById('saveIndicator');
            if (indicator) {
                indicator.classList.add('show');
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }
        }

        // Load game
        function loadGame() {
            const saved = localStorage.getItem('lecoeurdudonjon_save');
            if (saved) {
                try {
                    gameState = JSON.parse(saved);
                    
                    // Add energy properties if they don't exist (for backwards compatibility)
                    if (!gameState.player.hasOwnProperty('energy')) {
                        gameState.player.energy = 100;
                    }
                    if (!gameState.player.hasOwnProperty('maxEnergy')) {
                        gameState.player.maxEnergy = 100;
                    }
                    if (!gameState.player.hasOwnProperty('lastSleepTime')) {
                        gameState.player.lastSleepTime = null;
                    }
                } catch (e) {
                    console.error('Error loading save:', e);
                }
            }
        }

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>
